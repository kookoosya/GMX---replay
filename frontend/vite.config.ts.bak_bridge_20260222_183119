// PROXY_LEGACY_ROOT_FALLBACK_V3_NO_REGEX
import { defineConfig, loadEnv } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), "");
  const target = env.VITE_API_ORIGIN || "http://localhost:10000";

  const proxyCommon = {
    target,
    changeOrigin: true,
    secure: false,
  } as const;

  // Проксируем ТОЛЬКО корневые статические файлы вида /contents.XXXX.js /something.css /favicon.ico
  // чтобы legacy не умирал, если он ссылается на hashed bundle из корня.
  const bypassRootStaticOnly = (req: any) => {
    const url = (req?.url || "/") as string;
    const path = url.split("?")[0];

    // Vite служебные пути + главная React-страница
    if (
      path === "/" ||
      path.startsWith("/@") ||
      path.startsWith("/src") ||
      path.startsWith("/node_modules") ||
      path.startsWith("/__vite") ||
      path.startsWith("/@react-refresh")
    ) return url;

    // Эти маршруты и так проксируются отдельными правилами
    if (path.startsWith("/api") || path.startsWith("/app") || path.startsWith("/assets")) return url;

    // Только корень: /file.ext (без вложенных папок)
    const isRootLevel = path.startsWith("/") && path.indexOf("/", 1) === -1;
    if (!isRootLevel) return url;

    const name = path.slice(1);
    const looksLikeFile = name.includes(".");
    if (!looksLikeFile) return url;

    // undefined => НЕ bypass => пойдёт в proxy
    return undefined as any;
  };

  return {
    plugins: [react()],
    server: {
      port: 5173,
      strictPort: true,
      proxy: {
        "/api": proxyCommon,
        "/app": proxyCommon,
        "/assets": proxyCommon,

        // catch-all ТОЛЬКО для корневой статики (без regex)
        "/": { ...proxyCommon, bypass: bypassRootStaticOnly },
      },
    },
  };
});

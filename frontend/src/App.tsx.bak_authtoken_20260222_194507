import { useCallback, useEffect, useState } from "react";

type Usage = {
  ok: boolean;
  authenticated: boolean;
  gm?: { used: number; limit: number };
  gn?: { used: number; limit: number };
  resetAt?: string;
  sub?: { active: boolean; until: string | null };
  limits?: { freeDaily: number; dailyBonus: number; saveCapFree: number };
};

type AnyObj = any;

async function fetchAny(url: string): Promise<AnyObj> {
  const r = await fetch(url, { credentials: "include", cache: "no-store" });
  const text = await r.text();
  if (!r.ok) throw new Error(String(r.status) + " " + String(r.statusText) + " :: " + text.slice(0, 300));
  const t = text.trim();
  if ((t.startsWith("{") && t.endsWith("}")) || (t.startsWith("[") && t.endsWith("]"))) {
    try { return JSON.parse(t); } catch { return text; }
  }
  return text;
}

export default function App() {
  const [usage, setUsage] = useState<Usage | null>(null);
  const [refs, setRefs] = useState<AnyObj>(null);

  const [usageErr, setUsageErr] = useState("");
  const [refsErr, setRefsErr] = useState("");

  const load = useCallback(async () => {
    setUsageErr(""); setRefsErr("");
    try { setUsage(await fetchAny("/api/usage")); } catch (e: any) { setUsageErr(String(e?.message ?? e)); }
    try { setRefs(await fetchAny("/api/referral/stats")); } catch (e: any) { setRefsErr(String(e?.message ?? e)); }
  }, []);

  useEffect(() => { load(); }, [load]);

  const authed = !!usage?.authenticated;

  return (
    <div style={{ minHeight: "100vh", padding: 20, fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial" }}>
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12, flexWrap: "wrap" }}>
        <h1 style={{ margin: 0 }}>GMXReply</h1>
        <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
          <button onClick={load} style={btn}>Refresh</button>
          <a href="/app" style={{ ...btn, textDecoration: "none", display: "inline-flex", alignItems: "center" }}>
            Open /app (connect @handle)
          </a>
        </div>
      </div>

      <Card title="Auth status">
        <div><b>authenticated:</b> {String(authed)}</div>
        {!authed && (
          <div style={{ marginTop: 10, opacity: 0.85 }}>
            Открой <code>/app</code>, подключи @handle, потом вернись сюда и нажми Refresh
          </div>
        )}
      </Card>

      <Card title="Usage: /api/usage">
        <Err text={usageErr} />
        <Pre obj={usage} />
        {usage?.gm && usage?.gn && (
          <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "repeat(2, minmax(0, 1fr))", gap: 10 }}>
            <KV k="GM used/limit" v={`${usage.gm.used} / ${usage.gm.limit}`} />
            <KV k="GN used/limit" v={`${usage.gn.used} / ${usage.gn.limit}`} />
            <KV k="freeDaily" v={usage.limits?.freeDaily ?? ""} />
            <KV k="dailyBonus" v={usage.limits?.dailyBonus ?? ""} />
            <KV k="saveCapFree" v={usage.limits?.saveCapFree ?? ""} />
            <KV k="resetAt" v={usage.resetAt ?? ""} />
          </div>
        )}
      </Card>

      <Card title="Referrals: /api/referral/stats">
        <Err text={refsErr} />
        <Pre obj={refs} />
      </Card>
    </div>
  );
}

const btn: React.CSSProperties = {
  padding: "8px 12px",
  borderRadius: 10,
  border: "1px solid rgba(0,0,0,0.18)",
  background: "white",
  color: "#111",
  cursor: "pointer",
};

function Card({ title, children }: { title: string; children: any }) {
  return (
    <div style={{ marginTop: 16, padding: 14, borderRadius: 12, border: "1px solid rgba(0,0,0,0.12)" }}>
      <div style={{ opacity: 0.8, marginBottom: 10 }}>{title}</div>
      {children}
    </div>
  );
}

function Err({ text }: { text: string }) {
  if (!text) return null;
  return <div style={{ color: "#b00020", marginBottom: 10 }}><b>Error:</b> {text}</div>;
}

function Pre({ obj }: { obj: any }) {
  if (obj === null || obj === undefined) return <div style={{ opacity: 0.75 }}></div>;
  const s = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  return <pre style={{ margin: 0, padding: 12, background: "rgba(0,0,0,0.04)", borderRadius: 10, overflow: "auto" }}>{s}</pre>;
}

function KV({ k, v }: { k: string; v: any }) {
  return (
    <div style={{ padding: 10, borderRadius: 10, background: "rgba(0,0,0,0.03)" }}>
      <div style={{ fontSize: 12, opacity: 0.75 }}>{k}</div>
      <div style={{ marginTop: 4, fontSize: 16, fontWeight: 600 }}>{String(v)}</div>
    </div>
  );
}

// PROXY_LEGACY_ROOTLIST_V2_NO_REGEX
import { defineConfig, loadEnv } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig(({ mode }) => {
  // Note: loadEnv reads from CWD (frontend/ when running `npm --prefix frontend run dev`)
  const env = loadEnv(mode, process.cwd(), "");
  const target = env.VITE_API_ORIGIN || "http://localhost:10000";

  const proxyCommon = {
    target,
    changeOrigin: true,
    secure: false,
  } as const;

  return {
    plugins: [react()],
    server: {
      port: 5173,
      strictPort: true,

      // IMPORTANT:
      // Vite proxy "contexts" can be strings (prefix match) or regex-like strings starting with "^".
      // Regex strings are easy to break on Windows/Node due to escaping. We use ONLY string prefixes here.
      //
      // Goal: make http://localhost:5173 act as a same-origin shell for legacy http://localhost:10000/app
      // so the iframe can fully load /app plus its root files and /assets.
      proxy: {
        // API
        "/api": proxyCommon,

        // Legacy app route (covers /app, /app/, /app?x=..., /app/anything)
        "/app": proxyCommon,

        // Legacy root files (these are referenced by /app)
        "/app.js": proxyCommon,
        "/app.css": proxyCommon,
        "/mode.js": proxyCommon,
        "/themes.json": proxyCommon,
        "/extension-config.json": proxyCommon,
        "/entitlements.js": proxyCommon,
        "/favicon.ico": proxyCommon,
        "/manifest.json": proxyCommon,
        "/robots.txt": proxyCommon,

        // Legacy static assets (covers /assets/**)
        "/assets": proxyCommon,
      },
    },
  };
});
